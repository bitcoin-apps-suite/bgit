
var e=Object.create,t=Object.defineProperty,n=Object.getOwnPropertyDescriptor,r=Object.getOwnPropertyNames,i=Object.getPrototypeOf,a=Object.prototype.hasOwnProperty,o=(e,i,o,s)=>{if(i&&typeof i==`object`||typeof i==`function`)for(var c=r(i),l=0,u=c.length,d;l<u;l++)d=c[l],!a.call(e,d)&&d!==o&&t(e,d,{get:(e=>i[e]).bind(null,d),enumerable:!(s=n(i,d))||s.enumerable});return e},s=(n,r,a)=>(a=n==null?{}:e(i(n)),o(r||!n||!n.__esModule?t(a,`default`,{value:n,enumerable:!0}):a,n));let c=require(`node:path`);c=s(c);let l=require(`ansi-colors`);l=s(l);let u=require(`color-support`);u=s(u);const d=`heyapi.file`,f=`heyapi.node`,p=`heyapi.symbol`;l.default.enabled=(0,u.default)().hasBasic;const m=`heyapi`,h=/^(1|true|yes|on)$/i.test(process.env.HEYAPI_DISABLE_WARNINGS??``),g={analyzer:l.default.greenBright,dsl:l.default.cyanBright,file:l.default.yellowBright,registry:l.default.blueBright,symbol:l.default.magentaBright},_={deprecated:l.default.magentaBright};let v;function y(){if(v)return v;let e=process.env.DEBUG;return v=new Set(e?e.split(`,`).map(e=>e.trim().toLowerCase()):[]),v}const b=new Set;function x(e,t){let n=y();if(!(n.has(`*`)||n.has(`${m}:*`)||n.has(`${m}:${t}`)||n.has(t)))return;let r=(g[t]??l.default.whiteBright)(`${m}:${t}`);console.debug(`${r} ${e}`)}function S(e,t){if(h)return;let n=_[t]??l.default.yellowBright;console.warn(n(`${e}`))}function C({context:e,field:t,replacement:n}){let r=e?`${e}:${t}:${JSON.stringify(n)}`:`${t}:${JSON.stringify(n)}`;if(b.has(r))return;b.add(r);let i=`\`${t}\` is deprecated.`;if(n){let e=typeof n==`function`?n(t):n,r=(e instanceof Array?e:[e]).map(e=>`\`${e}\``).join(` or `);i+=` Use ${r} instead.`}S(`${e?`[${e}] `:``}${i}`,`deprecated`)}const w={debug:x,warn:S,warnDeprecated:C};var T=class{_exports=[];_extension;_finalPath;_imports=[];_language;_logicalFilePath;_name;_nodes=[];_renderer;"~brand"=`heyapi.file`;allNames=new Map;external;id;project;topLevelNames=new Map;constructor(e,t,n){this.external=e.external??!1,this.id=t,e.language!==void 0&&(this._language=e.language),this._logicalFilePath=e.logicalFilePath.split(c.default.sep).join(`/`),e.name!==void 0&&(this._name=e.name),this.project=n}get exports(){return[...this._exports]}get extension(){if(this.external)return;if(this._extension)return this._extension;let e=this.language,t=e?this.project.extensions[e]:void 0;if(t&&t[0])return t[0]}get finalPath(){return this._finalPath?this._finalPath:[...this._logicalFilePath?this._logicalFilePath.split(`/`).slice(0,-1):[],`${this.name}${this.extension??``}`].join(`/`)}get imports(){return[...this._imports]}get language(){if(this._language)return this._language;if(this._nodes[0])return this._nodes[0].language}get logicalFilePath(){return this._logicalFilePath}get name(){if(this._name)return this._name;let e=this._logicalFilePath.split(`/`).pop();if(e)return e;let t=`File ${this.toString()} has no name`;throw w.debug(t,`file`),Error(t)}get nodes(){return[...this._nodes]}get renderer(){return this._renderer}addExport(e){this._exports.push(e)}addImport(e){this._imports.push(e)}addNode(e){this._nodes.push(e),e.file=this}setExtension(e){this._extension=e}setFinalPath(e){this._finalPath=e}setLanguage(e){this._language=e}setName(e){this._name=e}setRenderer(e){this._renderer=e}toString(){return`[File ${this._logicalFilePath}#${this.id}]`}};function E(e,t){return!e||typeof e!=`object`?!1:e[`~brand`]===t}function D(e){return!e||typeof e!=`object`?!1:E(e,f)}function O(e){return E(e[`~ref`],f)}function k(e){return E(e,p)}function A(e){return E(e[`~ref`],p)}const j={c:[`.c`],"c#":[`.cs`],"c++":[`.cpp`,`.hpp`],css:[`.css`],dart:[`.dart`],go:[`.go`],haskell:[`.hs`],html:[`.html`],java:[`.java`],javascript:[`.js`,`.jsx`],json:[`.json`],kotlin:[`.kt`],lua:[`.lua`],markdown:[`.md`],matlab:[`.m`],perl:[`.pl`],php:[`.php`],python:[`.py`],r:[`.r`],ruby:[`.rb`],rust:[`.rs`],scala:[`.scala`],shell:[`.sh`],sql:[`.sql`],swift:[`.swift`],typescript:[`.ts`,`.tsx`],yaml:[`.yaml`,`.yml`]},M=({attempt:e,baseName:t})=>e===0?t:`${t}${e+1}`,N=({attempt:e,baseName:t})=>e===0?t:`${t}_${e+1}`,P={php:N,python:N,ruby:N};var F=class{_id=0;_values=new Map;project;constructor(e){this.project=e}get(e){return this._values.get(this.createFileKey(e))}isRegistered(e){return this._values.has(this.createFileKey(e))}get nextId(){return this._id++}register(e){let t=this.createFileKey(e),n=this._values.get(t);return n?e.name&&n.setName(e.name):n=new T(e,this.nextId,this.project),this._values.set(t,n),n}*registered(){for(let e of this._values.values())yield e}createFileKey(e){let t=e.logicalFilePath.split(c.default.sep).join(`/`);return`${e.external?`ext:`:``}${t}${e.language?`:${e.language}`:``}`}};const I=e=>B(e)?e:{"~ref":e},L=e=>{let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=I(e[n]));return t},R=e=>e?.[`~ref`],z=e=>{let t={};for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=R(e[n]));return t},B=e=>typeof e==`object`&&!!e&&`~ref`in e;var V=class{list=[];add(e){return this.list.push(I(e))-1}*all(){for(let e of this.list){let t=R(e);t&&(yield t)}}remove(e){this.list[e]=I(null)}update(e,t){this.list[e]=I(t)}};const H={class:3,enum:4,function:5,interface:1,namespace:0,type:2,var:6};function U(e,t){switch(H[e]>H[t]&&([e,t]=[t,e]),e){case`interface`:return t===`class`||t===`interface`;case`namespace`:return t===`class`||t===`enum`||t===`function`||t===`namespace`;case`type`:return t===`function`||t===`var`;default:return!1}}const W=(e={})=>({children:[],localNames:e.localNames||new Map,parent:e.parent,symbols:[]});var G=class{_parentStack=[];scope;scopes=W();symbol;constructor(e){this._parentStack.push(e),this.scope=this.scopes,this.symbol=e.symbol}get currentParent(){return this._parentStack[this._parentStack.length-1]}addChild(e,t=`container`){let n=this.currentParent;n&&(n.structuralChildren||=new Map,n.structuralChildren.set(e,t),e.structuralParents||=new Map,e.structuralParents.set(n,t))}addDependency(e){this.symbol!==R(e)&&this.scope.symbols.push(e)}analyze(e){let t=B(e)?e:I(e);if(A(t)){let e=R(t);e.node&&this.currentParent!==e.node&&this.addChild(e.node,`reference`),this.addDependency(t)}else if(O(t)){let e=R(t);this.addChild(e,`container`),this.pushParent(e),e.analyze(this),this.popParent()}}localNames(e){let t=new Map;for(let[n,r]of e.localNames)t.set(n,new Set(r));if(e.parent){let n=this.localNames(e.parent);for(let[e,r]of n)if(!t.has(e))t.set(e,r);else{let n=t.get(e);for(let e of r)n.add(e)}}return t}popParent(){this._parentStack.pop()}popScope(){this.scope=this.scope.parent??this.scope}pushParent(e){this._parentStack.push(e)}pushScope(){let e=W({parent:this.scope});this.scope.children.push(e),this.scope=e}walkScopes(e,t=this.scopes){this.scope=t;for(let n of t.symbols)e(n,t);for(let n of t.children)t=n,this.walkScopes(e,t);this.scope=this.scopes}},K=class{nodeCache=new WeakMap;analyzeNode(e){let t=this.nodeCache.get(e);if(t)return t;e.root=!0;let n=new G(e);return e.analyze(n),this.nodeCache.set(e,n),n}analyze(e,t){for(let n of e){let e=this.analyzeNode(n);t?.(e,n)}}};const q=e=>e===`type`||e===`interface`;var J=class{analyzer=new K;cacheResolvedNames=new Set;project;constructor(e){this.project=e}plan(e){this.cacheResolvedNames.clear(),this.allocateFiles(),this.assignLocalNames(),this.resolveFilePaths(e),this.planExports(),this.planImports()}allocateFiles(){this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.symbol;if(!n)return;let r=this.project.files.register({external:!1,language:t.language,logicalFilePath:n.getFilePath?.(n)||this.project.defaultFileName});r.addNode(t),n.setFile(r);for(let e of n.exportFrom)this.project.files.register({external:!1,language:r.language,logicalFilePath:e});e.walkScopes(e=>{let t=R(e);if(t.external&&t.isCanonical&&!t.file){let e=this.project.files.register({external:!0,language:t.node?.language,logicalFilePath:t.external});t.setFile(e)}})})}assignLocalNames(){this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.symbol;n&&this.assignTopLevelName({ctx:e,node:t,symbol:n})}),this.analyzer.analyze(this.project.nodes.all(),(e,t)=>{let n=t.file;n&&e.walkScopes(t=>{let r=R(t);r.file||this.assignLocalName({ctx:e,file:n,scopesToUpdate:[W({localNames:n.allNames})],symbol:r})})})}resolveFilePaths(e){for(let t of this.project.files.registered()){if(t.external){t.setFinalPath(t.logicalFilePath);continue}let n=this.project.fileName?.(t.name)||t.name;t.setName(n);let r=t.finalPath;r&&t.setFinalPath(c.default.resolve(this.project.root,r));let i={file:t,meta:e,project:this.project},a=this.project.renderers.find(e=>e.supports(i));a&&t.setRenderer(a)}}planExports(){let e=new Map,t=new Map;this.analyzer.analyze(this.project.nodes.all(),(n,r)=>{if(!r.exported)return;let i=r.symbol;if(!i)return;let a=r.file;if(a)for(let o of i.exportFrom){let s=this.project.files.register({external:!1,language:r.language,logicalFilePath:o});if(s.id===a.id)continue;let c=e.get(s);c||(c=new Map,e.set(s,c));let l=this.project.symbols.register({exported:!0,external:i.external,importKind:i.importKind,kind:i.kind,name:i.finalName});l.setFile(s),t.set(l.id,a),this.assignTopLevelName({ctx:n,symbol:l});let u=c.get(l.finalName);u||(u={kinds:new Set,symbol:l},c.set(l.finalName,u)),u.kinds.add(l.kind)}});for(let[n,r]of e){let e=new Map;for(let[,n]of r){let r=t.get(n.symbol.id),i=e.get(r);i||={canExportAll:!0,exports:[],from:r,isTypeOnly:!0};let a=[...n.kinds].every(e=>q(e)),o=n.symbol.finalName;i.exports.push({exportedName:o,isTypeOnly:a,kind:n.symbol.importKind,sourceName:n.symbol.name}),n.symbol.name!==n.symbol.finalName&&(i.canExportAll=!1),a||(i.isTypeOnly=!1),e.set(r,i)}for(let[,t]of e)n.addExport(t)}}planImports(){let e=new Map;this.analyzer.analyze(this.project.nodes.all(),t=>{let n=t.symbol;if(!n)return;let r=n.file;if(!r)return;let i=e.get(r);i||(i=new Map,e.set(r,i)),t.walkScopes(e=>{let n=R(e);if(!n.file||n.file.id===r.id)return;n.external&&this.assignTopLevelName({ctx:t,symbol:n});let a=n.file.id,o=n.finalName,s=q(n.kind),c=`${a}|${o}|${n.importKind}|${s}`,l=i.get(c);if(!l){let e=this.project.symbols.register({exported:n.exported,external:n.external,importKind:n.importKind,kind:n.kind,name:n.finalName});e.setFile(r),this.assignTopLevelName({ctx:t,scope:W({localNames:e.file.allNames}),symbol:e}),l={dep:n,kinds:new Set,symbol:e},i.set(c,l),l.kinds.add(e.kind)}e[`~ref`]=l.symbol})});for(let[t,n]of e){let e=new Map;for(let[,t]of n){let n=t.dep.file,r=e.get(n);r||={from:n,imports:[],isTypeOnly:!0,kind:`named`};let i=[...t.kinds].every(e=>q(e));t.symbol.importKind===`namespace`?(r.imports=[],r.kind=`namespace`,r.localName=t.symbol.finalName):t.symbol.importKind===`default`?(r.kind=`default`,r.localName=t.symbol.finalName):r.imports.push({isTypeOnly:i,localName:t.symbol.finalName,sourceName:t.dep.finalName}),i||(r.isTypeOnly=!1),e.set(n,r)}for(let[,n]of e)t.addImport(n)}}assignTopLevelName(e){e.symbol.file&&this.assignSymbolName({...e,file:e.symbol.file,scope:e?.scope??W({localNames:e.symbol.file.topLevelNames}),scopesToUpdate:[W({localNames:e.symbol.file.allNames}),e.ctx.scopes,...e?.scopesToUpdate??[]]})}assignLocalName(e){this.assignSymbolName({...e,scope:e.scope??e.ctx.scope})}assignSymbolName(e){let{ctx:t,file:n,node:r,scope:i,scopesToUpdate:a,symbol:o}=e;if(this.cacheResolvedNames.has(o.id))return;let s=o.name,c=r?.nameSanitizer?.(s)??o.node?.nameSanitizer?.(s)??s,l=1,u=t.localNames(i);for(;![...u.get(c)??[]].every(e=>U(o.kind,e));){let e=r?.language||o.node?.language||n.language,t=((e?this.project.nameConflictResolvers[e]:void 0)??this.project.defaultNameConflictResolver)({attempt:l,baseName:s});if(!t)throw Error(`Unresolvable name conflict: ${o.toString()}`);c=r?.nameSanitizer?.(t)??o.node?.nameSanitizer?.(t)??t,l+=1}o.setFinalName(c),this.cacheResolvedNames.add(o.id);let d=[i,...a];for(let e of d)this.updateScope(o,e)}updateScope(e,t){let n=e.finalName,r=t.localNames.get(n)??new Set;r.add(e.kind),t.localNames.set(n,r)}},Y=class{_canonical;_exported;_exportFrom;_external;_file;_finalName;_getFilePath;_importKind;_kind;_meta;_name;_node;"~brand"=p;id;constructor(e,t){this._exported=e.exported??!1,this._exportFrom=e.exportFrom??[],this._external=e.external,this._getFilePath=e.getFilePath,this.id=t,this._importKind=e.importKind??`named`,this._kind=e.kind??`var`,this._meta=e.meta,this._name=e.name}get canonical(){return this._canonical??this}get exported(){return this.canonical._exported}get exportFrom(){return this.canonical._exportFrom}get external(){return this.canonical._external}get file(){return this.canonical._file}get finalName(){if(!this.canonical._finalName){let e=`Symbol finalName has not been resolved yet for ${this.canonical.toString()}`;throw w.debug(e,`symbol`),Error(e)}return this.canonical._finalName}get getFilePath(){return this.canonical._getFilePath}get importKind(){return this.canonical._importKind}get isCanonical(){return!this._canonical||this._canonical===this}get kind(){return this.canonical._kind}get meta(){return this.canonical._meta}get name(){return this.canonical._name}get node(){return this.canonical._node}setCanonical(e){this._canonical=e}setExported(e){this.assertCanonical(),this._exported=e}setExportFrom(e){this.assertCanonical(),this._exportFrom=e}setFile(e){if(this.assertCanonical(),this._file&&this._file!==e){let e=`Symbol ${this.canonical.toString()} is already assigned to a different file.`;throw w.debug(e,`symbol`),Error(e)}this._file=e}setFinalName(e){if(this.assertCanonical(),this._finalName&&this._finalName!==e){let e=`Symbol finalName has already been resolved for ${this.canonical.toString()}.`;throw w.debug(e,`symbol`),Error(e)}this._finalName=e}setImportKind(e){this.assertCanonical(),this._importKind=e}setKind(e){this.assertCanonical(),this._kind=e}setName(e){this.assertCanonical(),this._name=e}setNode(e){if(this.assertCanonical(),this._node&&this._node!==e){let e=`Symbol ${this.canonical.toString()} is already bound to a different node.`;w.debug(e,`symbol`)}this._node=e,e.symbol=this}toString(){let e=this.canonical;return e._finalName&&e._finalName!==e._name?`[Symbol ${e._name} → ${e._finalName}#${e.id}]`:`[Symbol ${e._name}#${e.id}]`}assertCanonical(){if(this._canonical&&this._canonical!==this){let e=`Illegal mutation of stub symbol ${this.toString()} → canonical: ${this._canonical.toString()}`;throw w.debug(e,`symbol`),Error(e)}}},X=class{_id=0;_indices=new Map;_queryCache=new Map;_queryCacheDependencies=new Map;_registered=new Set;_stubs=new Set;_stubCache=new Map;_values=new Map;get(e){return typeof e==`number`?this._values.get(e):this.query(e)[0]}isRegistered(e){let t=this.get(e);return t?this._registered.has(t.id):!1}get nextId(){return this._id++}query(e){let t=this.buildCacheKey(e),n=this._queryCache.get(t);if(n)return n.map(e=>this._values.get(e));let r=[],i=this.buildIndexKeySpace(e),a=new Set,o=!1;for(let e of i){a.add(this.serializeIndexEntry(e));let t=this._indices.get(e[0]);if(!t){o=!0;break}let n=t.get(e[1]);if(!n){o=!0;break}r.push(n)}if(o||!r.length)return this._queryCacheDependencies.set(t,a),this._queryCache.set(t,[]),[];let s=new Set(r[0]);for(let e of r.slice(1))s=new Set([...s].filter(t=>e.has(t)));let c=[...s];return this._queryCacheDependencies.set(t,a),this._queryCache.set(t,c),c.map(e=>this._values.get(e))}reference(e){let[t]=this.query(e);if(t)return t;let n=this.buildCacheKey(e),r=this._stubCache.get(n);if(r!==void 0)return this._values.get(r);let i=new Y({meta:e,name:``},this.nextId);return this._values.set(i.id,i),this._stubs.add(i.id),this._stubCache.set(n,i.id),i}register(e){let t=new Y(e,this.nextId);if(this._values.set(t.id,t),this._registered.add(t.id),t.meta){let e=this.buildIndexKeySpace(t.meta);this.indexSymbol(t.id,e),this.invalidateCache(e),this.replaceStubs(t,e)}return t}*registered(){for(let e of this._registered.values())yield this._values.get(e)}buildCacheKey(e){return this.buildIndexKeySpace(e).map(e=>this.serializeIndexEntry(e)).sort().join(`|`)}buildIndexKeySpace(e,t=``){let n=[];for(let[r,i]of Object.entries(e)){let e=t?`${t}.${r}`:r;i&&typeof i==`object`&&!Array.isArray(i)?n.push(...this.buildIndexKeySpace(i,e)):n.push([e,i])}return n}indexSymbol(e,t){for(let[n,r]of t){this._indices.has(n)||this._indices.set(n,new Map);let t=this._indices.get(n),i=t.get(r)??new Set;i.add(e),t.set(r,i)}}invalidateCache(e){let t=e.map(e=>this.serializeIndexEntry(e));for(let[e,n]of this._queryCacheDependencies.entries())for(let r of t)if(n.has(r)){this._queryCacheDependencies.delete(e),this._queryCache.delete(e);break}}isSubset(e,t){let n=new Map(t);for(let[t,r]of e)if(!n.has(t)||n.get(t)!==r)return!1;return!0}replaceStubs(e,t){for(let n of this._stubs.values()){let r=this._values.get(n);if(r?.meta&&this.isSubset(this.buildIndexKeySpace(r.meta),t)){let t=this.buildCacheKey(r.meta);this._stubCache.delete(t),this._stubs.delete(n),r.setCanonical(e)}}}serializeIndexEntry(e){return`${e[0]}:${JSON.stringify(e[1])}`}},Z=class{files;nodes=new V;symbols=new X;defaultFileName;defaultNameConflictResolver;extensions;fileName;nameConflictResolvers;renderers;root;constructor(e){let t=e.fileName;this.defaultFileName=e.defaultFileName??`main`,this.defaultNameConflictResolver=e.defaultNameConflictResolver??M,this.extensions={...j,...e.extensions},this.fileName=typeof t==`string`?()=>t:t,this.files=new F(this),this.nameConflictResolvers={...P,...e.nameConflictResolvers},this.renderers=e.renderers??[],this.root=c.default.resolve(e.root).replace(/[/\\]+$/,``)}render(e){new J(this).plan(e);let t=[];for(let n of this.files.registered())if(!n.external&&n.finalPath&&n.renderer){let r=n.renderer.render({file:n,meta:e,project:this});t.push({content:r,path:n.finalPath})}return t}},Q=class e{children=new Map;items=[];name;parent;shell;shellSource;virtual;constructor(e,t,n){this.name=e,this.parent=t,this.virtual=n?.virtual??!1}get isRoot(){return!this.parent}child(t){return this.children.has(t)||this.children.set(t,new e(t,this)),this.children.get(t)}getPath(){let e=[],t=this;for(;t;)e.unshift(t.name),t=t.parent;return e}*itemsFrom(e){for(let t of this.items)t.source===e&&(yield t)}*walk(){for(let e of this.children.values())yield*e.walk();yield this}},$=class{_roots=new Map;_virtualRoot;get roots(){let e=Array.from(this._roots.values());return this._virtualRoot&&e.unshift(this._virtualRoot),e}insert(e){let{data:t,locations:n,source:r}=e;for(let e of n){let{path:n,shell:i}=e,a=n.filter(e=>!!e),o=a.slice(0,-1);if(!a[a.length-1])throw Error(`Cannot insert data without path.`);let s=null;for(let e of o)s=s?s.child(e):this.root(e),i&&!s.shell&&(s.shell=i,s.shellSource=r);s||=this.root(null),s.items.push({data:t,location:a,source:r})}}root(e){return e?(this._roots.has(e)||this._roots.set(e,new Q(e)),this._roots.get(e)):this._virtualRoot??=new Q(``,void 0,{virtual:!0})}*walk(){this._virtualRoot&&(yield*this._virtualRoot.walk());for(let e of this._roots.values())yield*e.walk()}};exports.File=T,exports.Project=Z,exports.StructureModel=$,exports.StructureNode=Q,exports.Symbol=Y,exports.defaultExtensions=j,exports.defaultNameConflictResolvers=P,exports.fromRef=R,exports.fromRefs=z,exports.isNode=D,exports.isNodeRef=O,exports.isRef=B,exports.isSymbol=k,exports.isSymbolRef=A,exports.log=w,exports.nodeBrand=f,exports.ref=I,exports.refs=L,exports.simpleNameConflictResolver=M,exports.symbolBrand=p,exports.underscoreNameConflictResolver=N;
//# sourceMappingURL=index.cjs.map